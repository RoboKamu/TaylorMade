<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Power Consumption – Today</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 1rem;
    }

    canvas {
      max-width: 100%;
      height: 400px;
    }
  </style>
</head>
<body>
  <h2>[ Today ]</h2>
  <h3>Live Data</h3>
  <canvas id="powerChart"></canvas>

  <script>
    async function fetchData() {
      const res = await fetch("/data");
      const data = await res.json();

      const timeLabels = [];
      const powerValues = [];
      const energyValues = [];

      let cumulativeEnergy = 0;

      data.forEach((row, i) => {
        const time = row.timestamp.split(" ")[1]; // show only time
        const power = parseFloat(row.power);

        if (!isNaN(power)) {
          cumulativeEnergy += power * (5 / 3600); // 5 seconds interval → kWh
          timeLabels.push(time);
          powerValues.push(power);
          energyValues.push(cumulativeEnergy.toFixed(2));
        }
      });

      const ctx = document.getElementById("powerChart").getContext("2d");

      new Chart(ctx, {
        type: "line",
        data: {
          labels: timeLabels,
          datasets: [
            {
              label: "Power (W)",
              data: powerValues,
              borderWidth: 2,
              yAxisID: 'y1',
            },
            {
              label: "Cumulative Energy (kWh)",
              data: energyValues,
              borderWidth: 2,
              borderDash: [5, 5],
              yAxisID: 'y2',
            }
          ]
        },
        options: {
          scales: {
            y1: {
              type: 'linear',
              position: 'left',
              title: {
                display: true,
                text: 'Watt'
              }
            },
            y2: {
              type: 'linear',
              position: 'right',
              title: {
                display: true,
                text: 'kWh'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });
    }

    fetchData();
  </script>
</body>
</html>
